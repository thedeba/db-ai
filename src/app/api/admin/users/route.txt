import { NextResponse } from 'next/server';
import clientPromise from '@/lib/mongodb';

export async function GET() {
  try {
    const client = await clientPromise;
    console.log('MongoDB connected');

    // Use the test database
    const db = client.db('test');
    const usersCollection = db.collection('users');

    console.log('Fetching users from test database...');
    const users = await usersCollection.find({}).toArray();
    console.log(`Found ${users.length} users`);

    // Transform the data for JSON response
    const cleanUsers = users.map(user => ({
      _id: user._id.toString(),
      name: user.name || '',
      email: user.email || '',
      role: user.role || 'user',
      createdAt: user.createdAt ? new Date(user.createdAt).toISOString() : null,
      lastLogin: user.lastLogin ? new Date(user.lastLogin).toISOString() : null
    }));

    return NextResponse.json(cleanUsers);
  } catch (error) {
    console.error('Error in users API:', error);
    return NextResponse.json({ error: 'Failed to fetch users' }, { status: 500 });
  }
}
